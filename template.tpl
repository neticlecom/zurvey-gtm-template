___TERMS_OF_SERVICE___

By creating or modifying this file you agree to Google Tag Manager's Community
Template Gallery Developer Terms of Service available at
https://developers.google.com/tag-manager/gallery-tos (or such other URL as
Google may provide), as modified from time to time.


___INFO___

{
  "type": "TAG",
  "id": "cvt_temp_public_id",
  "version": 1,
  "categories": ["SURVEY"],
  "securityGroups": [],
  "displayName": "Zurvey - popup survey",
  "brand": {
    "id": "zurvey",
    "displayName": "Zurvey",
    "thumbnail": "data:image/png;base64,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"
  },
  "description": "Zurvey Popup Integration. Zurvey is a professional survey solution that perfectly understands textual answers. This template helps you ask the right questions at the right time, easily via GTM.",
  "containerContexts": [
    "WEB"
  ]
}


___TEMPLATE_PARAMETERS___

[
  {
    "type": "TEXT",
    "name": "id",
    "displayName": "Survey unique ID",
    "simpleValueType": true,
    "alwaysInSummary": false,
    "valueValidators": [
      {
        "type": "NON_EMPTY"
      }
    ]
  },
  {
    "type": "TEXT",
    "name": "title",
    "displayName": "Popup title",
    "simpleValueType": true,
    "alwaysInSummary": false,
    "valueValidators": [
      {
        "type": "NON_EMPTY"
      }
    ]
  },
  {
    "type": "TEXT",
    "name": "color",
    "displayName": "Color",
    "simpleValueType": true,
    "canBeEmptyString": true,
    "valueHint": "e.g. #1cc6ba",
    "valueValidators": [
      {
        "type": "REGEX",
        "args": [
          "^#[a-fA-F0-9]{3,6}|"
        ]
      }
    ]
  },
  {
    "type": "PARAM_TABLE",
    "name": "urlParameters",
    "displayName": "URL parameters",
    "paramTableColumns": [
      {
        "param": {
          "type": "TEXT",
          "name": "key",
          "displayName": "",
          "simpleValueType": true
        },
        "isUnique": true
      },
      {
        "param": {
          "type": "TEXT",
          "name": "value",
          "displayName": "",
          "simpleValueType": true
        },
        "isUnique": false
      }
    ],
    "editRowTitle": "Edit parameter",
    "newRowButtonText": "New parameter",
    "newRowTitle": "New parameter"
  }
]


___SANDBOXED_JS_FOR_WEB_TEMPLATE___

const log = require('logToConsole');
  const injectScript = require('injectScript');
  const queryPermission = require('queryPermission');
  const callInWindow = require('callInWindow');
  const url = 'https://s.zurvey.io/embed.js';

  const parameters = {};
  if(data.urlParameters) {
    data.urlParameters.map(
      function(p) {
        parameters[p.key] = p.value;
      }
    );
  }

  const options = {
    color: data.color
  };

  const onSuccess = () => {
    log('Script loaded successfully.', data.id, data.title, parameters, options);
    callInWindow('zurvey', data.id, data.title, parameters ? parameters : {}, options);
    data.gtmOnSuccess();
  };

  const onFailure = () => {
    log('Script load failed.');
    data.gtmOnFailure();
  };

  if (queryPermission('inject_script', url)) {
    injectScript(url, onSuccess, onFailure, 'zurvey-embed');
  } else {
    log('Script load failed due to permissions mismatch.');
    data.gtmOnFailure();
  }


___WEB_PERMISSIONS___

[
  {
    "instance": {
      "key": {
        "publicId": "logging",
        "versionId": "1"
      },
      "param": [
        {
          "key": "environments",
          "value": {
            "type": 1,
            "string": "debug"
          }
        }
      ]
    },
    "clientAnnotations": {
      "isEditedByUser": true
    },
    "isRequired": true
  },
  {
    "instance": {
      "key": {
        "publicId": "access_globals",
        "versionId": "1"
      },
      "param": [
        {
          "key": "keys",
          "value": {
            "type": 2,
            "listItem": [
              {
                "type": 3,
                "mapKey": [
                  {
                    "type": 1,
                    "string": "key"
                  },
                  {
                    "type": 1,
                    "string": "read"
                  },
                  {
                    "type": 1,
                    "string": "write"
                  },
                  {
                    "type": 1,
                    "string": "execute"
                  }
                ],
                "mapValue": [
                  {
                    "type": 1,
                    "string": "zurvey"
                  },
                  {
                    "type": 8,
                    "boolean": false
                  },
                  {
                    "type": 8,
                    "boolean": false
                  },
                  {
                    "type": 8,
                    "boolean": true
                  }
                ]
              }
            ]
          }
        }
      ]
    },
    "clientAnnotations": {
      "isEditedByUser": true
    },
    "isRequired": true
  },
  {
    "instance": {
      "key": {
        "publicId": "inject_script",
        "versionId": "1"
      },
      "param": [
        {
          "key": "urls",
          "value": {
            "type": 2,
            "listItem": [
              {
                "type": 1,
                "string": "https://s.zurvey.io/"
              }
            ]
          }
        }
      ]
    },
    "clientAnnotations": {
      "isEditedByUser": true
    },
    "isRequired": true
  }
]


___TESTS___

scenarios:
- name: Test
  code: |-
    const mockData = {
      id: 12345,
      title: "asdfghjk",
      color: "#123321",
      urlParameters: [{
        "key": "group",
        "value": "fb"
      }]
    };

    // Call runCode to run the template's code.
    runCode(mockData);

    // Verify that the tag finished successfully.
    assertApi('gtmOnSuccess').wasCalled();


___NOTES___

Created on 9/17/2020, 9:32:16 AM


